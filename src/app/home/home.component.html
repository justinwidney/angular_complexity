<goa-container accent="thin" padding="relaxed" width="full">

  <div class="flex-container">

    <!-- First Row: Dropdowns + Chart Type -->
    <div class="row">
      <div class="col-8">
        <div class="row">
          <div class="col">
            <div class="data-setting-wrapper">
              <div class="data-setting-component">
                <goa-form-item label="Region" labelSize="regular">
                  <goa-dropdown name="region" 
                    [value]="currentRegion"
                    matTooltip="Select region" 
                    matTooltipPosition="above" 
                    width="180px"
                    (_change)="onChange($event, 'region')"
                    [disabled]="isLoadingData"
                  >
                    <goa-dropdown-item value="Alberta" label="Alberta"></goa-dropdown-item>
                    <goa-dropdown-item value="Canada" label="Canada"></goa-dropdown-item>
                    <goa-dropdown-item value="British Columbia" label="British Columbia"></goa-dropdown-item>
                    <goa-dropdown-item value="Manitoba" label="Manitoba"></goa-dropdown-item>
                    <goa-dropdown-item value="New Brunswick" label="New Brunswick"></goa-dropdown-item>
                    <goa-dropdown-item value="Newfoundland and Labrador" label="Newfoundland and Labrador"></goa-dropdown-item>
                    <goa-dropdown-item value="Nova Scotia" label="Nova Scotia"></goa-dropdown-item>
                    <goa-dropdown-item value="Ontario" label="Ontario"></goa-dropdown-item>
                    <goa-dropdown-item value="Prince Edward Island" label="Prince Edward Island"></goa-dropdown-item>
                    <goa-dropdown-item value="Quebec" label="Quebec"></goa-dropdown-item>
                    <goa-dropdown-item value="Saskatchewan" label="Saskatchewan"></goa-dropdown-item>
                  </goa-dropdown>
                </goa-form-item>
              </div>
            </div>
          </div>
          
          <goa-spacer hspacing="m"></goa-spacer>

          <div class="col">
            <div class="data-setting-wrapper">
              <div class="data-setting-component">
                <goa-form-item label="Year" labelSize="regular">
                  <goa-dropdown name="year" 
                    [value]="currentYear"
                    matTooltip="Select year" 
                    matTooltipPosition="above" 
                    width="180px"
                    (_change)="onChange($event, 'year')"
                    [disabled]="isLoadingData"
                  >
                    <!-- Dynamic years based on available data -->
                    <goa-dropdown-item 
                      *ngFor="let year of availableYears" 
                      [value]="year" 
                      [label]="year">
                    </goa-dropdown-item>
                  </goa-dropdown>
                </goa-form-item>
              </div>
            </div>
          </div>

          <goa-spacer hspacing="m"></goa-spacer>

          <div class="col">
            <div class="data-setting-wrapper">
              <div class="data-setting-component">
                <goa-form-item label="Grouping" labelSize="regular">
                  <goa-dropdown name="grouping" 
                    [value]="getGroupingValue()"
                    matTooltip="Select HS digit grouping" 
                    matTooltipPosition="above" 
                    width="180px"
                    (_change)="onChange($event, 'grouping')"
                    [disabled]="isLoadingData"
                  >
                    <goa-dropdown-item value="HS2" label="HS 2"></goa-dropdown-item>
                    <goa-dropdown-item value="HS4" label="HS 4"></goa-dropdown-item>
                    <goa-dropdown-item value="NAICS2" label="NAICS 2"></goa-dropdown-item>
                    <goa-dropdown-item value="NAICS4" label="NAICS 4"></goa-dropdown-item>

                  </goa-dropdown>
                </goa-form-item>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-4">
        <div class="row">
          <div class="col">
            <goa-form-item label="Chart Type" labelSize="small">
              <div class="modern-chart-toggles">
                <mat-button-toggle-group 
                  name="chartType" 
                  aria-label="Chart Type" 
                  [value]="selectedChartType" 
                  (change)="onChartTypeChange($event)"
                  [disabled]="isLoadingData">
                  <mat-button-toggle value="ProductSpace">Product Space</mat-button-toggle>
                  <mat-button-toggle value="Feasible">Feasible</mat-button-toggle>
                  <mat-button-toggle value="Trends">Trends</mat-button-toggle>
                  <mat-button-toggle value="Exports">Exports</mat-button-toggle>
                  <mat-button-toggle value="ECI">ECI</mat-button-toggle>
                </mat-button-toggle-group>
              </div>
            </goa-form-item>
          </div>
        </div>
      </div>
    </div>

    <goa-spacer vspacing="m"></goa-spacer>
    <div class="row">
      <div class="col-12">
        <goa-divider></goa-divider>
      </div>
    </div>
    <goa-spacer vspacing="m"></goa-spacer>

    <!-- Second Row: Title + Stats + Controls -->
    <div class="row align-items-center space-between">
      <div class="col">
        <goa-text mt="none" mb="none" as="h4">
          Export Dashboard - {{currentRegion}} ({{currentYear}})
        </goa-text>
      </div>

      <div class="col">
        <goa-text mt="none" mb="none" as="h5">
          Total Value: {{totalValue}}
        </goa-text>
      </div>

      <div class="col">
        <goa-text mt="none" mb="none" as="h5">
         Products: {{productCount | number}}
        </goa-text>
      </div>

        <div class="col">
          <div class="filter-buttons-wrapper">
            <goa-form-item label="Filters" labelSize="small">
              <div class="filter-button-group">
                <goa-button 
                  type="secondary" 
                  size="compact" 
                  [variant]="currentDisplayFilter === 'default' ? 'primary' : 'secondary'"
                  (_click)="onFilterChange('default')" 
                  [disabled]="isLoadingData">
                  <goa-icon name="view-grid" slot="prefix"></goa-icon>
                  All
                </goa-button>
                
                <goa-button 
                  type="secondary" 
                  size="compact" 
                  [variant]="currentDisplayFilter === 'frontier' ? 'primary' : 'secondary'"
                  (_click)="onFilterChange('frontier')" 
                  [disabled]="isLoadingData">
                  <goa-icon name="trending-up" slot="prefix"></goa-icon>
                  Frontier
                </goa-button>
                
                <goa-button 
                  type="secondary" 
                  size="compact" 
                  [variant]="currentDisplayFilter === 'quadrants' ? 'primary' : 'secondary'"
                  (_click)="onFilterChange('quadrants')" 
                  [disabled]="isLoadingData">
                  <goa-icon name="view-module" slot="prefix"></goa-icon>
                  Quads
                </goa-button>
              </div>
            </goa-form-item>
          </div>
        </div>

      <div class="col">
        <goa-input name="search" type="search" placeholder="Search products..." width="200px"></goa-input>
      </div>
    </div>

    <!-- Loading/Error States -->
    <div class="row" *ngIf="isLoadingData || dataError">
      <div class="col-12">
        <goa-spacer vspacing="m"></goa-spacer>
        <goa-notification *ngIf="isLoadingData" type="information">
          <span slot="heading">Loading data...</span>
          <p>Fetching data for {{currentRegion}} ({{currentYear}})</p>
        </goa-notification>
        

      </div>
    </div>

    <goa-spacer vspacing="m"></goa-spacer>

    <!-- Third Row: Charts -->
    <div class="row" *ngIf="selectedChartType === 'ProductSpace'">
      <div class="col-12" style="position: relative;">
        
        <app-product-space-chart 
          #productSpaceChart
          [showGroupLabels]="showLabels"
          [customGroupLabels]="customLabels"
          [tooltipEnabled]="true"
          [highlightConnections]="true"
          (nodeSelected)="onNodeSelected($event)"
          (nodeHovered)="onNodeHovered($event)"
          (rowHighlight)="onRowHighlight($event)"
          >
        </app-product-space-chart>

        <!-- Floating Info Panel for Selected Node -->
        <div class="floating-info-panel" *ngIf="selectedNode">
          <div class="card">
            <div class="card-header">
              <h6 class="mb-0">Selected Product: {{selectedNode!.node.id}}</h6>
            </div>
            <div class="card-body p-3">
              <p class="mb-2"><strong>Cluster:</strong> {{selectedNode!.node.cluster_name}}</p>
              <p class="mb-2"><strong>Value:</strong> {{selectedNode!.data?.Value | number}}</p>
              <p class="mb-2"><strong>RCA:</strong> {{selectedNode!.data?.rca | number:'1.4-4'}}</p>
              <p class="mb-2"><strong>Description:</strong> {{selectedNode!.data?.description}}</p>
              <p class="mb-2"><strong>Industry:</strong> {{selectedNode!.data?.naics_description}}</p>
              <button class="btn btn-sm btn-secondary w-100" (click)="clearSelection()">Clear Selection</button>
            </div>
          </div>
        </div>
      </div>
    </div>



    <div class="row" *ngIf="selectedChartType === 'Feasible'">
      <div class="col-12">
        <app-feasible-chart 
          #feasibleChart
          [showTooltips]="true"
          [enableIconFiltering]="true"
          [enableTracking]="true"
          (chartDataLoaded)="feasibleStats = $event"
          (nodeSelected)="onFeasiblePointSelected($event)"
          (nodeHovered)="onFeasiblePointHovered($event)"
        >
        </app-feasible-chart>
      </div>  
    </div>

    <div class="row" *ngIf="selectedChartType === 'Trends'">
      <div class="col-12">
        <app-overtime-chart
          #overtimeChart
          [showDebugInfo]="false"
          [showTooltips]="true"
          [enableCategoryToggling]="true"
          [enableDataTable]="true">
        </app-overtime-chart>
      </div>  
    </div>

    <div class="row" *ngIf="selectedChartType === 'Exports'">
      <div class="col-12">
        <app-treemap-chart
          #treemapChart
          [enableZoomPan]="true"
          [showControls]="true"
          [showDebugInfo]="false">
        </app-treemap-chart>
      </div>
    </div>

    <div class="row" *ngIf="selectedChartType === 'ECI'">
      <div class="col-12">
        <app-eci-chart
          #eciChart
          [showControls]="true"
          [showCacheStatus]="true"
          [enableTooltips]="true"
          [enableLegend]="true"
        >
        </app-eci-chart>
      </div>
    </div>

    <div class="row">
      <div class="col-12">
          <app-table></app-table>
      </div>
    </div>

    <!-- Debug Panel (optional) -->
    <div class="row" *ngIf="false">
      <div class="col-12">
        <goa-spacer vspacing="l"></goa-spacer>
        <div class="card">
          <div class="card-header">
            <h6>Debug Info</h6>
          </div>
          <div class="card-body">
            <p><strong>Region:</strong> {{currentRegion}}</p>
            <p><strong>Year:</strong> {{currentYear}}</p>
            <p><strong>Grouping:</strong> {{currentGrouping}}</p>
            <p><strong>Chart Type:</strong> {{selectedChartType}}</p>
            <p><strong>Loading:</strong> {{isLoadingData}}</p>
            <p><strong>Error:</strong> {{dataError || 'None'}}</p>
            <button class="btn btn-sm btn-info" (click)="getCacheStatus()">Check Cache Status</button>
          </div>
        </div>
      </div>
    </div>

  </div>  

</goa-container>